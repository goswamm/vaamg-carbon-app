<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VAAMG Carbon Footprint Calculator (DOS / DEFRA 2025)</title>
  <!-- Tailwind CDN for quick utility classes -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- CSV + XLSX helpers -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.1/dist/xlsx.full.min.js"></script>
  <style>
    /* Minimal design tokens */
    :root { --ring: #3b82f6; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; }
    th { background: #f8fafc; font-weight: 600; text-align: left; }
    .pill { display:inline-flex; align-items:center; gap:.4rem; padding:.2rem .6rem; border-radius:9999px; font-size:.75rem; }
    .pill-good { background:#ecfdf5; color:#047857; }
    .pill-warn { background:#fff7ed; color:#9a3412; }
    .pill-bad { background:#fef2f2; color:#b91c1c; }
    .btn { padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:.6rem; background:white; }
    .btn:hover { background:#f9fafb; }
    .btn-primary { background:#2563eb; color:white; border-color:#2563eb; }
    .btn-primary:hover { background:#1d4ed8; }
    .btn-danger { background:#dc2626; color:white; border-color:#dc2626; }
    .btn-danger:hover { background:#b91c1c; }
    .card { background:white; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.05); padding:1rem; }
    .input, .select { border:1px solid #e5e7eb; border-radius:.6rem; padding:.35rem .5rem; width:100%; background:white; }
    .input:focus, .select:focus, button:focus { outline:2px solid var(--ring); outline-offset:2px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:1rem; }
    .grid-4 { display:grid; grid-template-columns: repeat(4, 1fr); gap:1rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .overlay { position:fixed; inset:0; background:#0f172acc; display:flex; align-items:center; justify-content:center; z-index:50; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- AUTH GATE (optional) -->
  <div id="authGate" class="overlay hidden">
    <div class="card max-w-md w-full space-y-3">
      <h2 class="text-xl font-semibold">Restricted</h2>
      <p class="text-sm text-gray-600">Enter passphrase to continue.</p>
      <input id="authInput" type="password" class="input" placeholder="Passphrase" />
      <div class="flex items-center gap-2">
        <button id="authSubmit" class="btn-primary">Unlock</button>
        <button id="authCancel" class="btn">Cancel</button>
        <span id="authStatus" class="text-sm text-red-600"></span>
      </div>
      <p class="text-xs text-gray-500">Tip: add <span class="mono">?key=PASSWORD</span> to the URL. This gate is minimal and not suitable for sensitive data.</p>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
    <header class="flex items-center justify-between gap-2 flex-wrap">
      <h1 class="text-2xl md:text-3xl font-bold">VAAMG Carbon Footprint Calculator <span class="text-gray-400 text-base font-normal">(DOS / DEFRA 2025)</span></h1>
      <div class="flex gap-2">
        <button id="btnExportData" class="btn" title="Export your inputs as JSON">Export Data</button>
        <button id="btnImportData" class="btn" title="Import a previously exported JSON">Import Data</button>
        <input id="importDataInput" type="file" accept="application/json" class="hidden" />
        <button id="btnExportXLSX" class="btn" title="Download full workbook (XLSX)">Download XLSX</button>
        <button id="btnOpenSettings" class="btn" title="Manage lists and options">Settings</button>
      </div>
    </header>

    <!-- Settings -->
    <section id="settings" class="card space-y-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Settings</h2>
        <button id="btnCloseSettings" class="btn">Close</button>
      </div>
      <details open>
        <summary class="font-semibold cursor-pointer">Suppliers (Cloud + Market‑based electricity)</summary>
        <div class="text-sm text-gray-600 mb-2">Add suppliers and, if applicable, their <b>market‑based electricity EF</b> (kgCO2e/kWh from supplier certificates).</div>
        <div id="suppliersTable" class="overflow-auto"></div>
        <div class="mt-2 flex justify-end"><button id="btnAddSupplier" class="btn">Add supplier</button></div>
      </details>
      <details>
        <summary class="font-semibold cursor-pointer">Purchased service categories</summary>
        <div id="categoriesTable" class="overflow-auto"></div>
        <div class="mt-2 flex justify-end"><button id="btnAddCategory" class="btn">Add category</button></div>
      </details>
      <details>
        <summary class="font-semibold cursor-pointer">Electricity options (Scope 3 adders)</summary>
        <div class="text-sm text-gray-600">When enabled on rows, the app looks for these DEFRA activity keys:
          <code class="mono">UK Electricity - transmission & distribution (kgCO2e/kWh)</code>,
          <code class="mono">UK Electricity - well-to-tank (kgCO2e/kWh)</code>.
          Ensure your loaded dataset includes them.</div>
      </details>
    </section>

    <!-- Factors Loader -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <h2 class="text-xl font-semibold">1) Load DEFRA 2025 <span class="font-normal">(Full set)</span></h2>
        <div class="flex items-center gap-2">
          <input id="defraFile" type="file" accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="hidden" />
          <button id="btnLoadFile" class="btn">Load file (CSV/XLSX)</button>
          <button id="btnClearFactors" class="btn">Clear factors</button>
        </div>
      </div>
      <p class="text-sm text-gray-600">Expected headers: <span class="mono">Activity</span>, <span class="mono">Unit</span>, <span class="mono">Factor (kgCO2e per unit)</span>.</p>
      <textarea id="defraPaste" class="input mono" rows="4" placeholder="Or paste CSV here (first row must include headers)"></textarea>
      <div class="flex items-center gap-2">
        <button id="btnParsePaste" class="btn">Parse pasted CSV</button>
        <span id="factorsStatus" class="pill pill-warn">No factors loaded (using placeholders)</span>
      </div>
      <details class="mt-2">
        <summary class="cursor-pointer text-sm text-gray-700">Show first 10 activities loaded</summary>
        <div id="factorsPreview" class="mt-2 text-sm mono whitespace-pre-wrap"></div>
      </details>
    </section>

    <!-- Inputs -->
    <section class="card space-y-3">
      <h2 class="text-xl font-semibold">2) Enter activity data</h2>
      <nav class="flex flex-wrap gap-2 mb-2">
        <button class="btn" data-tab="Electricity_Use">Electricity</button>
        <button class="btn" data-tab="Gas_Use">Gas</button>
        <button class="btn" data-tab="Business_Travel">Business travel</button>
        <button class="btn" data-tab="Commuting">Commuting</button>
        <button class="btn" data-tab="Cloud_Services">Cloud/IT</button>
        <button class="btn" data-tab="Purchased_Services">Purchased services</button>
        <button class="btn" data-tab="Hotels">Hotels</button>
        <button class="btn" data-tab="Couriers">Couriers</button>
      </nav>
      <div id="tabs"></div>
    </section>

    <!-- Results & CRP -->
    <section class="card space-y-3">
      <h2 class="text-xl font-semibold">3) Results & CRP summary</h2>
      <div class="grid-3">
        <label class="text-sm">Baseline Year
          <select id="baselineYear" class="select"></select>
        </label>
        <label class="text-sm">Most Recent Year
          <select id="recentYear" class="select"></select>
        </label>
        <div class="text-sm">Status
          <div id="statusBadge" class="pill pill-warn mt-1">Using placeholder factors</div>
        </div>
      </div>
      <div class="overflow-auto mt-2">
        <table id="resultsTable" class="min-w-full text-sm"></table>
      </div>
      <div class="grid-4 mt-2 text-sm">
        <div class="card"><div class="text-gray-500">Baseline Emissions (tCO2e)</div><div id="baselineTotal" class="text-xl font-semibold">–</div></div>
        <div class="card"><div class="text-gray-500">Current Emissions (tCO2e)</div><div id="currentTotal" class="text-xl font-semibold">–</div></div>
        <div class="card"><div class="text-gray-500">Reduction vs Baseline</div><div id="reductionPct" class="text-xl font-semibold">–</div></div>
        <div class="flex items-end"><button id="btnExportResults" class="btn-primary px-4 py-2 rounded-lg">Export results (CSV)</button></div>
      </div>
      <p class="text-xs text-gray-500">Electricity Scope 3 (T&D/WTT) is counted under Scope 3 when those adders are enabled per row.</p>
    </section>

    <footer class="text-xs text-gray-500 text-center">All data saves to your browser’s localStorage. This tool uses per‑unit factors from the DEFRA 2025 full set you load. Minimal passphrase gate is best‑effort only.</footer>
  </div>

  <script>
  // -----------------------
  // AUTH (minimal)
  // -----------------------
  // Set a passphrase to enable the gate. Leave empty for no auth.
  const PASSPHRASE_PLAIN = '';
  const GATE = { enabled: !!PASSPHRASE_PLAIN };
  function showGate() { document.getElementById('authGate').classList.remove('hidden'); }
  function hideGate() { document.getElementById('authGate').classList.add('hidden'); }
  function tryUnlock(input) {
    if (!GATE.enabled) return true;
    const a = String(input || '').trim();
    const b = String(PASSPHRASE_PLAIN || '').trim();
    if (a === b) { sessionStorage.setItem('vaamg_gate_ok','1'); return true; }
    return false;
  }
    return false;
  }

  (function gateInit(){
    if (!GATE.enabled) return; // disabled
    const url = new URL(location.href);
    const key = url.searchParams.get('key');
    if (key && tryUnlock(key)) { hideGate(); return; }
    if (sessionStorage.getItem('vaamg_gate_ok')==='1') { hideGate(); return; }
    showGate();
    const inputEl = document.getElementById('authInput');
    const submitEl = document.getElementById('authSubmit');
    const cancelEl = document.getElementById('authCancel');
    const statusEl = document.getElementById('authStatus');
    submitEl.addEventListener('click', ()=>{
      const ok = tryUnlock(inputEl.value);
      statusEl.textContent = ok ? '' : 'Wrong passphrase';
      if (ok) hideGate();
    });
    inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') submitEl.click(); });
    cancelEl.addEventListener('click', ()=>{ location.href='about:blank'; });
  })();

  // -----------------------
  // Utility helpers
  // -----------------------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const deepClone = (x) => JSON.parse(JSON.stringify(x));
  const fmt = (n, d=4) => (isFinite(n) ? Number(n).toFixed(d) : "");
  const toNumber = (v) => { const n = parseFloat(v); return isFinite(n) ? n : 0; };
  function download(filename, blobOrText) {
    const blob = blobOrText instanceof Blob ? blobOrText : new Blob([blobOrText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
  }
  function downloadCSV(filename, rows) {
    if (!rows.length) { download(filename, ''); return; }
    const headers = Object.keys(rows[0]);
    const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? "")).join(','))).join('\n');
    download(filename, csv);
  }

  // -----------------------
  // Constants & Lists (now dynamic)
  // -----------------------
  const YEARS = Array.from({length: 12}, (_,i) => 2024 + i); // 2024-2035
  const DEFAULT_SUPPLIERS = [
    { name:"Oracle Cloud Infrastructure (OCI)", mb_ef:'' },
    { name:"Oracle Analytics Cloud (OAC)", mb_ef:'' },
    { name:"Oracle Fusion Applications", mb_ef:'' },
    { name:"AWS", mb_ef:'' },
    { name:"Microsoft Azure", mb_ef:'' },
    { name:"Google Cloud (GCP)", mb_ef:'' },
    { name:"Hostinger", mb_ef:'' },
    { name:"Wix", mb_ef:'' },
    { name:"Ionos", mb_ef:'' },
    { name:"Other", mb_ef:'' }
  ];
  const DEFAULT_CATEGORIES = ["Consultancy","Subcontractor","Software","Hardware/Equipment","Training","Travel","Accommodation","Courier","Other"];

  const MODES = ["Car - Petrol","Car - Diesel","Car - EV","Car - Hybrid","Train","Bus - Local","Bus - Coach","Taxi","Motorcycle","Short Haul Flight","Long Haul Flight","Ferry","Walking","Cycling"];
  const UNITS = ["miles","km","nights","kg_km"]; // used variably

  const MODE_TO_KEY = {
    "Car - Petrol": "Car - Petrol (kgCO2e/mile)",
    "Car - Diesel": "Car - Diesel (kgCO2e/mile)",
    "Car - EV": "Car - EV (kgCO2e/mile)",
    "Car - Hybrid": "Car - Hybrid (kgCO2e/mile)",
    "Motorcycle": "Motorcycle (kgCO2e/mile)",
    "Taxi": "Taxi (kgCO2e/mile)",
    "Train": "Train (kgCO2e/mile)",
    "Bus - Local": "Bus - Local (kgCO2e/passenger mile)",
    "Bus - Coach": "Bus - Coach (kgCO2e/passenger mile)",
    "Short Haul Flight": "Short Haul Flight <3700km (kgCO2e/passenger km)",
    "Long Haul Flight": "Long Haul Flight >3700km (kgCO2e/passenger km)",
    "Ferry": "Ferry (kgCO2e/passenger km)",
    "Walking": "Walking (kgCO2e/mile)",
    "Cycling": "Cycling (kgCO2e/mile)"
  };

  const KEYS = {
    ELECTRICITY_LB: "Electricity (UK grid, kgCO2e/kWh)", // location-based
    ELECTRICITY_TND: "UK Electricity - transmission & distribution (kgCO2e/kWh)",
    ELECTRICITY_WTT: "UK Electricity - well-to-tank (kgCO2e/kWh)",
    GAS: "Natural Gas (kgCO2e/kWh)",
    CLOUD: "Cloud/IT Services (kgCO2e/£ spend)",
    PGS: "Purchased Goods & Services (kgCO2e/£ spend)",
    HOTEL: "Hotel Stay (kgCO2e/night)",
    COURIER: "Courier (kgCO2e/kg_km)"
  };

  // Placeholder factors if DEFRA not loaded
  const FALLBACKS = {
    [KEYS.ELECTRICITY_LB]: 0.193,
    [KEYS.ELECTRICITY_TND]: 0.020, // example placeholder ~20 gCO2e/kWh
    [KEYS.ELECTRICITY_WTT]: 0.030, // example placeholder ~30 gCO2e/kWh
    [KEYS.GAS]: 0.183,
    [MODE_TO_KEY["Car - Petrol"]]: 0.280,
    [MODE_TO_KEY["Car - Diesel"]]: 0.300,
    [MODE_TO_KEY["Car - EV"]]: 0.060,
    [MODE_TO_KEY["Car - Hybrid"]]: 0.180,
    [MODE_TO_KEY["Motorcycle"]]: 0.180,
    [MODE_TO_KEY["Taxi"]]: 0.300,
    [MODE_TO_KEY["Train"]]: 0.041,
    [MODE_TO_KEY["Bus - Local"]]: 0.170,
    [MODE_TO_KEY["Bus - Coach"]]: 0.100,
    [MODE_TO_KEY["Short Haul Flight"]]: 0.158,
    [MODE_TO_KEY["Long Haul Flight"]]: 0.146,
    [MODE_TO_KEY["Ferry"]]: 0.115,
    [KEYS.HOTEL]: 16.0,
    [KEYS.COURIER]: 0.500,
    [KEYS.CLOUD]: 0.040,
    [KEYS.PGS]: 0.250
  };

  // DEFRA factors map: { Activity: { unit, factor } }
  let DEFRA = {};

  const state = {
    lists: {
      suppliers: deepClone(DEFAULT_SUPPLIERS),
      categories: deepClone(DEFAULT_CATEGORIES)
    },
    Electricity_Use: [], // {year,kwh,notes,method:'Location-based'|'Market-based', supplier:'', include_tnd:true, include_wtt:true, ef_used, tco2e_lb, tco2e_tnd, tco2e_wtt}
    Gas_Use: [],
    Business_Travel: [],
    Commuting: [],
    Cloud_Services: [],
    Purchased_Services: [],
    Hotels: [],
    Couriers: [],
    baselineYear: YEARS[0],
    recentYear: YEARS[1]
  };

  // -----------------------
  // Local storage
  // -----------------------
  const LS_KEY = 'vaamg_carbon_v2';
  function saveState() { localStorage.setItem(LS_KEY, JSON.stringify({ state, DEFRA })); }
  function loadState() {
    const raw = localStorage.getItem(LS_KEY); if (!raw) return;
    try { const saved = JSON.parse(raw); if (saved && typeof saved==='object') { Object.assign(state, saved.state||{}); DEFRA = saved.DEFRA||{}; } } catch {}
  }

  // -----------------------
  // DEFRA factor loading
  // -----------------------
  function setFactorsStatus() {
    const loaded = Object.keys(DEFRA).length;
    const badge = $('#factorsStatus'); const status = $('#statusBadge');
    if (loaded>0) { badge.textContent = `Loaded ${loaded} activities`; badge.className='pill pill-good'; status.textContent='Using DEFRA full set'; status.className='pill pill-good'; }
    else { badge.textContent='No factors loaded (using placeholders)'; badge.className='pill pill-warn'; status.textContent='Using placeholder factors'; status.className='pill pill-warn'; }
  }
  function parseDefraRows(rows) {
    const out={}; const A=(s)=>String(s||'').trim();
    for(const r of rows){ const act=A(r['Activity']??r['activity']); const unit=A(r['Unit']??r['unit']); const fstr=A(r['Factor (kgCO2e per unit)']??r['kgCO2e per unit']??r['factor']); if(!act||!fstr) continue; const factor=parseFloat(fstr); if(!isFinite(factor)) continue; out[act]={unit,factor}; }
    return out;
  }
  function previewDefra(defra){ const first10=Object.entries(defra).slice(0,10).map(([k,v])=>`${k} | ${v.unit} | ${v.factor}`).join('\n'); $('#factorsPreview').textContent=first10||'(none)'; }
  function getFactor(key){ return DEFRA[key]?.factor ?? (FALLBACKS[key] ?? 0); }
  function isFallback(key){ return !DEFRA[key]; }

  // -----------------------
  // UI primitives
  // -----------------------
  function makeSelect(vals, value){ const sel=document.createElement('select'); sel.className='select'; vals.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); sel.value=value ?? vals[0]; return sel; }
  function makeInput(type='text', value=''){ const inp=document.createElement('input'); inp.type=type; inp.value=value??''; inp.className='input'; return inp; }
  function makeBtn(text, cls, onClick){ const b=document.createElement('button'); b.textContent=text; b.className=cls; b.addEventListener('click', onClick); return b; }
  function makeYearSelect(value){ return makeSelect(YEARS.map(String), String(value??YEARS[0])); }

  // -----------------------
  // Settings: Suppliers & Categories
  // -----------------------
  function renderSuppliers(){
    const host=$('#suppliersTable'); host.innerHTML='';
    const table=document.createElement('table');
    table.innerHTML='<thead><tr><th>Name</th><th>Market-based EF (kgCO2e/kWh)</th><th></th></tr></thead>';
    const tbody=document.createElement('tbody');
    state.lists.suppliers.forEach((s,i)=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); const name=makeInput('text', s.name); td1.appendChild(name);
      const td2=document.createElement('td'); const ef=makeInput('number', s.mb_ef); ef.step='any'; ef.min='0'; td2.appendChild(ef);
      const td3=document.createElement('td'); td3.appendChild(makeBtn('Delete','btn-danger',()=>{ state.lists.suppliers.splice(i,1); saveState(); renderSuppliers(); renderActiveTab(); }));
      [td1,td2,td3].forEach(td=>tr.appendChild(td));
      name.addEventListener('input',()=>{ s.name=name.value; saveState(); renderActiveTab(); });
      ef.addEventListener('input',()=>{ s.mb_ef=ef.value; saveState(); });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody); host.appendChild(table);
  }
  function renderCategories(){
    const host=$('#categoriesTable'); host.innerHTML='';
    const table=document.createElement('table');
    table.innerHTML='<thead><tr><th>Category</th><th></th></tr></thead>';
    const tbody=document.createElement('tbody');
    state.lists.categories.forEach((c,i)=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); const name=makeInput('text', c); td1.appendChild(name);
      const td2=document.createElement('td'); td2.appendChild(makeBtn('Delete','btn-danger',()=>{ state.lists.categories.splice(i,1); saveState(); renderCategories(); renderActiveTab(); }));
      tr.appendChild(td1); tr.appendChild(td2);
      name.addEventListener('input',()=>{ state.lists.categories[i]=name.value; saveState(); renderActiveTab(); });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody); host.appendChild(table);
  }

  $('#btnOpenSettings').addEventListener('click',()=>{ $('#settings').classList.remove('hidden'); renderSuppliers(); renderCategories(); });
  $('#btnCloseSettings').addEventListener('click',()=>$('#settings').classList.add('hidden'));
  $('#btnAddSupplier').addEventListener('click',()=>{ state.lists.suppliers.push({name:'New Supplier', mb_ef:''}); saveState(); renderSuppliers(); renderActiveTab(); });
  $('#btnAddCategory').addEventListener('click',()=>{ state.lists.categories.push('New Category'); saveState(); renderCategories(); renderActiveTab(); });

  // -----------------------
  // Sheet render helpers
  // -----------------------
  function renderTable(container, cfg){
    container.innerHTML='';
    const table=document.createElement('table');
    const thead=document.createElement('thead'); const trh=document.createElement('tr');
    cfg.columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c.label; trh.appendChild(th); });
    const thAct=document.createElement('th'); thAct.textContent='Actions'; trh.appendChild(thAct); thead.appendChild(trh); table.appendChild(thead);
    const tbody=document.createElement('tbody');

    function renderRow(row){
      const tr=document.createElement('tr');
      cfg.columns.forEach(col=>{
        const td=document.createElement('td');
        let el;
        const v=row[col.key];
        if (col.type==='year'){ el=makeYearSelect(v); }
        else if (col.type==='mode'){ el=makeSelect(MODES, v); }
        else if (col.type==='unit'){ el=makeSelect(col.allowed||['miles','km'], v); }
        else if (col.type==='supplier'){ el=makeSelect(state.lists.suppliers.map(s=>s.name), v); }
        else if (col.type==='category'){ el=makeSelect(state.lists.categories, v); }
        else if (col.type==='select'){ el=makeSelect(col.options, v); }
        else if (col.type==='number'){ el=makeInput('number', v); el.step='any'; el.min='0'; }
        else if (col.type==='checkbox'){ el=makeInput('checkbox', ''); el.checked=!!v; el.className=''; }
        else if (col.type==='readonly'){ el=document.createElement('div'); el.className='mono'; el.textContent=col.format?col.format(row): (row[col.key]??''); }
        else { el=makeInput('text', v); }
        if (col.help) el.title=col.help;
        td.appendChild(el); tr.appendChild(td);
        if (col.type!=='readonly'){
          el.addEventListener('input',()=>{ if(col.type==='number'){ row[col.key]=toNumber(el.value);} else if (col.type==='checkbox'){ row[col.key]=el.checked; } else { row[col.key]=el.value; } cfg.recalc(row); saveState(); renderActiveTab(); renderResults(); });
          el.addEventListener('change',()=>{ if(col.type==='number'){ row[col.key]=toNumber(el.value);} else if (col.type==='checkbox'){ row[col.key]=el.checked; } else { row[col.key]=el.value; } cfg.recalc(row); saveState(); renderActiveTab(); renderResults(); });
        }
      });
      const tdAct=document.createElement('td'); tdAct.appendChild(makeBtn('Delete','btn-danger',()=>{ const i=cfg.rows.indexOf(row); if(i>-1){ cfg.rows.splice(i,1); saveState(); renderActiveTab(); renderResults(); } })); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    }

    cfg.rows.forEach(renderRow);
    table.appendChild(tbody);
    const addBar=document.createElement('div'); addBar.className='mt-2 flex justify-end';
    addBar.appendChild(makeBtn('Add row','btn',()=>{ cfg.rows.push(deepClone(cfg.emptyRow())); saveState(); renderActiveTab(); }));
    container.appendChild(table); container.appendChild(addBar);
  }

  // -----------------------
  // Conversions
  // -----------------------
  const milesToKm = (m)=>m*1.60934; const kmToMiles=(k)=>k/1.60934;

  // -----------------------
  // Tabs (with electricity MB + T&D/WTT)
  // -----------------------
  const Sheets = {
    Electricity_Use: {
      rows: state.Electricity_Use,
      emptyRow: () => ({ year:YEARS[0], kwh:0, notes:'', method:'Location-based', supplier:'', include_tnd:false, include_wtt:false, ef_used:0, tco2e:0, tnd:0, wtt:0, scope:'Scope 2' }),
      recalc: (r) => {
        // EF selection
        let ef = 0; let fallbackStar='';
        if (r.method==='Market-based'){
          const s = state.lists.suppliers.find(x=>x.name===r.supplier);
          const mb = parseFloat(s?.mb_ef);
          if (isFinite(mb)) { ef = mb; }
          else { ef = getFactor(KEYS.ELECTRICITY_LB); fallbackStar='*'; } // fallback to LB if no supplier EF
        } else {
          ef = getFactor(KEYS.ELECTRICITY_LB); if (isFallback(KEYS.ELECTRICITY_LB)) fallbackStar='*';
        }
        r.ef_used = ef; r.tco2e = (toNumber(r.kwh)*ef)/1000;
        // Adders (Scope 3)
        r.tnd = r.include_tnd ? (toNumber(r.kwh)*getFactor(KEYS.ELECTRICITY_TND))/1000 : 0;
        r.wtt = r.include_wtt ? (toNumber(r.kwh)*getFactor(KEYS.ELECTRICITY_WTT))/1000 : 0;
        r._flag = fallbackStar;
      },
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'kwh', label:'kWh', type:'number' },
        { key:'notes', label:'Location/Notes', type:'text' },
        { key:'method', label:'Method', type:'select', options:['Location-based','Market-based'] },
        { key:'supplier', label:'Supplier (for Market-based)', type:'supplier' },
        { key:'include_tnd', label:'Add T&D (Scope 3)', type:'checkbox' },
        { key:'include_wtt', label:'Add WTT (Scope 3)', type:'checkbox' },
        { key:'ef_used', label:'EF used (kgCO2e/kWh)', type:'readonly', format:(r)=>fmt(r.ef_used,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e (Scope 2)', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'tnd', label:'T&D tCO2e (S3)', type:'readonly', format:(r)=>fmt(r.tnd,6) },
        { key:'wtt', label:'WTT tCO2e (S3)', type:'readonly', format:(r)=>fmt(r.wtt,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    },
    Gas_Use: {
      rows: state.Gas_Use,
      emptyRow: () => ({ year:YEARS[0], kwh:0, notes:'', factor:0, tco2e:0, scope:'Scope 1' }),
      recalc: (r) => { const f=getFactor(KEYS.GAS); r.factor=f; r.tco2e=(toNumber(r.kwh)*f)/1000; r._flag=isFallback(KEYS.GAS); },
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'kwh', label:'kWh', type:'number' },
        { key:'notes', label:'Location/Notes', type:'text' },
        { key:'factor', label:'EF (kgCO2e/kWh)', type:'readonly', format:(r)=>fmt(r.factor,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    },
    Business_Travel: {
      rows: state.Business_Travel,
      emptyRow: () => ({ year:YEARS[0], mode:MODES[0], distance:0, notes:'', unit:'miles', factor:0, tco2e:0, scope:'Scope 3' }),
      recalc: (r) => {
        const key=MODE_TO_KEY[r.mode]; const f=getFactor(key); r.factor=f; r._flag=isFallback(key);
        const d=toNumber(r.distance);
        const isKmMode = (r.mode==='Short Haul Flight'||r.mode==='Long Haul Flight'||r.mode==='Ferry');
        if (isKmMode){ const km=r.unit==='miles'?milesToKm(d):d; r.tco2e=(km*f)/1000; }
        else { const miles=r.unit==='km'?kmToMiles(d):d; r.tco2e=(miles*f)/1000; }
      },
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'mode', label:'Mode', type:'mode' },
        { key:'distance', label:'Miles/KM', type:'number' },
        { key:'notes', label:'Notes', type:'text' },
        { key:'unit', label:'Unit', type:'unit', allowed:['miles','km'] },
        { key:'factor', label:'EF', type:'readonly', format:(r)=>fmt(r.factor,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    },
    Commuting: {
      rows: state.Commuting,
      emptyRow: () => ({ year:YEARS[0], mode:MODES[0], distance:0, notes:'', unit:'miles', factor:0, tco2e:0, scope:'Scope 3' }),
      recalc: (r) => Sheets.Business_Travel.recalc(r),
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'mode', label:'Mode', type:'mode' },
        { key:'distance', label:'Miles/KM', type:'number' },
        { key:'notes', label:'Notes', type:'text' },
        { key:'unit', label:'Unit', type:'unit', allowed:['miles','km'] },
        { key:'factor', label:'EF', type:'readonly', format:(r)=>fmt(r.factor,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    },
    Cloud_Services: {
      rows: state.Cloud_Services,
      emptyRow: () => ({ year:YEARS[0], supplier:'', spend:0, notes:'', factor:0, tco2e:0, scope:'Scope 3' }),
      recalc: (r) => { const f=getFactor(KEYS.CLOUD); r.factor=f; r._flag=isFallback(KEYS.CLOUD); r.tco2e=(toNumber(r.spend)*f)/1000; },
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'supplier', label:'Supplier', type:'supplier' },
        { key:'spend', label:'Spend £', type:'number' },
        { key:'notes', label:'Notes', type:'text' },
        { key:'factor', label:'EF (kgCO2e/£)', type:'readonly', format:(r)=>fmt(r.factor,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    },
    Purchased_Services: {
      rows: state.Purchased_Services,
      emptyRow: () => ({ year:YEARS[0], category:'', spend:0, notes:'', factor:0, tco2e:0, scope:'Scope 3' }),
      recalc: (r) => { const f=getFactor(KEYS.PGS); r.factor=f; r._flag=isFallback(KEYS.PGS); r.tco2e=(toNumber(r.spend)*f)/1000; },
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'category', label:'Category', type:'category' },
        { key:'spend', label:'Spend £', type:'number' },
        { key:'notes', label:'Notes', type:'text' },
        { key:'factor', label:'EF (kgCO2e/£)', type:'readonly', format:(r)=>fmt(r.factor,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    },
    Hotels: {
      rows: state.Hotels,
      emptyRow: () => ({ year:YEARS[0], nights:0, place:'', factor:0, tco2e:0, scope:'Scope 3' }),
      recalc: (r) => { const f=getFactor(KEYS.HOTEL); r.factor=f; r._flag=isFallback(KEYS.HOTEL); r.tco2e=(toNumber(r.nights)*f)/1000; },
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'nights', label:'Nights', type:'number' },
        { key:'place', label:'Country/City', type:'text' },
        { key:'factor', label:'EF (kgCO2e/night)', type:'readonly', format:(r)=>fmt(r.factor,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    },
    Couriers: {
      rows: state.Couriers,
      emptyRow: () => ({ year:YEARS[0], kg:0, distance:0, unit:'km', factor:0, tco2e:0, scope:'Scope 3' }),
      recalc: (r) => { const f=getFactor(KEYS.COURIER); r.factor=f; r._flag=isFallback(KEYS.COURIER); const kg=toNumber(r.kg), d=toNumber(r.distance); const km=(r.unit==='miles')?milesToKm(d):d; r.tco2e=(kg*km*f)/1000; },
      columns: [
        { key:'year', label:'Year', type:'year' },
        { key:'kg', label:'Kg', type:'number' },
        { key:'distance', label:'Distance', type:'number' },
        { key:'unit', label:'Unit', type:'select', options:['km','miles'] },
        { key:'factor', label:'EF (kgCO2e/kg_km)', type:'readonly', format:(r)=>fmt(r.factor,6)+(r._flag?' *':'') },
        { key:'tco2e', label:'tCO2e', type:'readonly', format:(r)=>fmt(r.tco2e,6) },
        { key:'scope', label:'Scope', type:'readonly' }
      ]
    }
  };

  // -----------------------
  // Results
  // -----------------------
  function rollupByYear(){
    const byYear={}; YEARS.forEach(y=>byYear[y]={s1:0,s2:0,s3:0,total:0});
    const add=(y,scope,val)=>{ if(!byYear[y]) byYear[y]={s1:0,s2:0,s3:0,total:0}; byYear[y][scope]+=val; };
    state.Gas_Use.forEach(r=>add(r.year,'s1',toNumber(r.tco2e)));
    state.Electricity_Use.forEach(r=>{ add(r.year,'s2',toNumber(r.tco2e)); add(r.year,'s3',toNumber(r.tnd)+toNumber(r.wtt)); });
    ['Business_Travel','Commuting','Cloud_Services','Purchased_Services','Hotels','Couriers'].forEach(s=>state[s].forEach(r=>add(r.year,'s3',toNumber(r.tco2e))));
    YEARS.forEach(y=>byYear[y].total=byYear[y].s1+byYear[y].s2+byYear[y].s3);
    return byYear;
  }
  function renderResults(){
    const byYear=rollupByYear();
    const headers=['Year','Scope 1 (tCO2e)','Scope 2 (tCO2e)','Scope 3 (tCO2e)','Total (tCO2e)'];
    const rows=YEARS.map(y=>[y,fmt(byYear[y].s1),fmt(byYear[y].s2),fmt(byYear[y].s3),fmt(byYear[y].total)]);
    $('#resultsTable').innerHTML='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>'+rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')+'</tbody>';
    const base=byYear[state.baselineYear]?.total??0; const curr=byYear[state.recentYear]?.total??0; $('#baselineTotal').textContent=fmt(base); $('#currentTotal').textContent=fmt(curr); $('#reductionPct').textContent=(base>0)?((1-curr/base)*100).toFixed(1)+'%':'–';
  }

  // -----------------------
  // Tabs
  // -----------------------
  let activeTab='Electricity_Use';
  function renderActiveTab(){ const host=$('#tabs'); host.innerHTML=''; const container=document.createElement('div'); renderTable(container, Sheets[activeTab]); host.appendChild(container); }
  function setActive(tab){ activeTab=tab; $$('nav [data-tab]').forEach(b=>b.classList.toggle('btn-primary', b.dataset.tab===tab)); renderActiveTab(); }
  $$('nav [data-tab]').forEach(b=>b.addEventListener('click',()=>setActive(b.dataset.tab)));

  // -----------------------
  // DEFRA file/paste handlers
  // -----------------------
  $('#btnLoadFile').addEventListener('click',()=>$('#defraFile').click());
  $('#defraFile').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return;
    if (file.name.toLowerCase().endsWith('.csv')){ Papa.parse(file,{header:true,complete:(res)=>{ DEFRA=parseDefraRows(res.data); setFactorsStatus(); previewDefra(DEFRA); recomputeAll(); saveState(); }}); }
    else { const buf=await file.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(ws,{defval:''}); DEFRA=parseDefraRows(json); setFactorsStatus(); previewDefra(DEFRA); recomputeAll(); saveState(); }
    e.target.value='';
  });
  $('#btnParsePaste').addEventListener('click',()=>{ const text=$('#defraPaste').value.trim(); if(!text) return; const res=Papa.parse(text,{header:true}); DEFRA=parseDefraRows(res.data); setFactorsStatus(); previewDefra(DEFRA); recomputeAll(); saveState(); });
  $('#btnClearFactors').addEventListener('click',()=>{ DEFRA={}; setFactorsStatus(); previewDefra(DEFRA); recomputeAll(); saveState(); });

  // -----------------------
  // Export/Import JSON
  // -----------------------
  $('#btnExportData').addEventListener('click',()=>download('vaamg-carbon-data.json', JSON.stringify({ state, DEFRA }, null, 2)));
  $('#btnImportData').addEventListener('click',()=>$('#importDataInput').click());
  $('#importDataInput').addEventListener('change', async (e)=>{ const file=e.target.files[0]; if(!file) return; const text=await file.text(); try{ const obj=JSON.parse(text); Object.assign(state, obj.state||{}); DEFRA=obj.DEFRA||{}; }catch{} setFactorsStatus(); previewDefra(DEFRA); recomputeAll(); saveState(); e.target.value=''; });

  // -----------------------
  // Export Results CSV
  // -----------------------
  $('#btnExportResults').addEventListener('click',()=>{ const by=rollupByYear(); const rows=YEARS.map(y=>({Year:y, Scope1_tCO2e:by[y].s1, Scope2_tCO2e:by[y].s2, Scope3_tCO2e:by[y].s3, Total_tCO2e:by[y].total})); downloadCSV('vaamg_results.csv', rows); });

  // -----------------------
  // XLSX Export (multi-sheet)
  // -----------------------
  $('#btnExportXLSX').addEventListener('click',()=>{
    const wb=XLSX.utils.book_new();
    function sheetFromRows(name, headers, rows){ const aoa=[headers, ...rows.map(r=>headers.map(h=>r[h]??''))]; const ws=XLSX.utils.aoa_to_sheet(aoa); XLSX.utils.book_append_sheet(wb, ws, name); }

    // DEFRA sheet
    sheetFromRows('DEFRA_2025_Full', ['Activity','Unit','Factor (kgCO2e per unit)'], Object.entries(DEFRA).map(([k,v])=>({ Activity:k, Unit:v.unit||'', 'Factor (kgCO2e per unit)':v.factor })) );

    // Electricity (include MB, T&D, WTT)
    sheetFromRows('Electricity_Use', ['Year','kWh','Notes','Method','Supplier','EF_used','tCO2e_Scope2','T&D_tCO2e','WTT_tCO2e','Scope'], state.Electricity_Use.map(r=>({ Year:r.year, kWh:r.kwh, Notes:r.notes, Method:r.method, Supplier:r.supplier, EF_used:r.ef_used, tCO2e_Scope2:r.tco2e, 'T&D_tCO2e':r.tnd, 'WTT_tCO2e':r.wtt, Scope:r.scope })) );

    sheetFromRows('Gas_Use', ['Year','kWh','Notes','EF','tCO2e','Scope'], state.Gas_Use.map(r=>({Year:r.year,kWh:r.kwh,Notes:r.notes,EF:r.factor,tCO2e:r.tco2e,Scope:r.scope})) );

    function commonTravelRows(arr){ return arr.map(r=>({Year:r.year, Mode:r.mode, Distance:r.distance, Unit:r.unit, Notes:r.notes, EF:r.factor, tCO2e:r.tco2e, Scope:r.scope})); }
    sheetFromRows('Business_Travel', ['Year','Mode','Distance','Unit','Notes','EF','tCO2e','Scope'], commonTravelRows(state.Business_Travel));
    sheetFromRows('Commuting', ['Year','Mode','Distance','Unit','Notes','EF','tCO2e','Scope'], commonTravelRows(state.Commuting));

    sheetFromRows('Cloud_Services', ['Year','Supplier','Spend_£','Notes','EF','tCO2e','Scope'], state.Cloud_Services.map(r=>({Year:r.year,Supplier:r.supplier,'Spend_£':r.spend,Notes:r.notes,EF:r.factor,tCO2e:r.tco2e,Scope:r.scope})) );
    sheetFromRows('Purchased_Services', ['Year','Category','Spend_£','Notes','EF','tCO2e','Scope'], state.Purchased_Services.map(r=>({Year:r.year,Category:r.category,'Spend_£':r.spend,Notes:r.notes,EF:r.factor,tCO2e:r.tco2e,Scope:r.scope})) );
    sheetFromRows('Hotels', ['Year','Nights','Place','EF','tCO2e','Scope'], state.Hotels.map(r=>({Year:r.year,Nights:r.nights,Place:r.place,EF:r.factor,tCO2e:r.tco2e,Scope:r.scope})) );
    sheetFromRows('Couriers', ['Year','Kg','Distance','Unit','EF','tCO2e','Scope'], state.Couriers.map(r=>({Year:r.year,Kg:r.kg,Distance:r.distance,Unit:r.unit,EF:r.factor,tCO2e:r.tco2e,Scope:r.scope})) );

    // Results
    const by=rollupByYear(); sheetFromRows('Results', ['Year','Scope1_tCO2e','Scope2_tCO2e','Scope3_tCO2e','Total_tCO2e'], YEARS.map(y=>({Year:y, Scope1_tCO2e:by[y].s1, Scope2_tCO2e:by[y].s2, Scope3_tCO2e:by[y].s3, Total_tCO2e:by[y].total})) );

    // CRP
    const base=by[state.baselineYear]?.total??0; const curr=by[state.recentYear]?.total??0; const red=(base>0)?(1-curr/base):0;
    sheetFromRows('CRP_Summary', ['Field','Value'], [
      {Field:'Net Zero Commitment Year', Value:'2050'},
      {Field:'Baseline Year', Value:String(state.baselineYear)},
      {Field:'Most Recent Year', Value:String(state.recentYear)},
      {Field:'Baseline Emissions (tCO2e)', Value:base},
      {Field:'Current Emissions (tCO2e)', Value:curr},
      {Field:'Reduction vs Baseline (%)', Value:(red*100).toFixed(1)+'%'}
    ]);

    // Lists
    sheetFromRows('Lists_Suppliers', ['Name','MarketBased_EF_kgCO2e_per_kWh'], state.lists.suppliers.map(s=>({Name:s.name, MarketBased_EF_kgCO2e_per_kWh:s.mb_ef}))); 
    sheetFromRows('Lists_Categories', ['Category'], state.lists.categories.map(c=>({Category:c})));

    const out=XLSX.write(wb,{bookType:'xlsx', type:'array'});
    download('vaamg_workbook.xlsx', new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
  });

  // -----------------------
  // Init
  // -----------------------
  function fillYearSelects(){ const by=$('#baselineYear'), ry=$('#recentYear'); YEARS.forEach(y=>{ const o1=document.createElement('option'); o1.value=y; o1.textContent=y; by.appendChild(o1); const o2=document.createElement('option'); o2.value=y; o2.textContent=y; ry.appendChild(o2); }); by.value=state.baselineYear; ry.value=state.recentYear; by.addEventListener('change',()=>{ state.baselineYear=parseInt(by.value,10); saveState(); renderResults(); }); ry.addEventListener('change',()=>{ state.recentYear=parseInt(ry.value,10); saveState(); renderResults(); }); }
  function recomputeAll(){ Object.values(Sheets).forEach(cfg=>cfg.rows.forEach(r=>cfg.recalc(r))); renderActiveTab(); renderResults(); }

  loadState();
  // seed default rows
  if (state.Electricity_Use.length===0) state.Electricity_Use.push({ year:YEARS[0], kwh:0, notes:'', method:'Location-based', supplier: state.lists.suppliers[0]?.name||'', include_tnd:false, include_wtt:false, ef_used:0, tco2e:0, tnd:0, wtt:0, scope:'Scope 2' });
  if (state.Gas_Use.length===0) state.Gas_Use.push({ year:YEARS[0], kwh:0, notes:'', factor:0, tco2e:0, scope:'Scope 1' });

  fillYearSelects(); setFactorsStatus(); setActive(activeTab); recomputeAll();
  </script>
</body>
</html>
